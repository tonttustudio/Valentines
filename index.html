<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
<title>Syd√§nStudio ‚ú®</title>
<style>
:root { --main-pink: #ff4d6d; --bg-color: #fff0f3; --dark-pink: #590d22; }
body { margin: 0; background: var(--bg-color); font-family: 'Fredoka', sans-serif; touch-action: none; overflow: hidden; }
.wrap { max-width: 720px; margin: 0 auto; padding: 10px; height: 100vh; display: flex; flex-direction: column; }
.topblock { background: var(--bg-color); padding-bottom: 10px; flex-shrink: 0; }
h1 { margin: 0; padding: 10px 0; text-align: center; color: var(--main-pink); font-family: 'Dancing Script', cursive; font-size: 36px; }
.toolbar { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
button, label.button { 
    background: var(--main-pink); color: white; border: none; padding: 8px 16px; 
    border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 14px;
    box-shadow: 0 4px 0 #c9184a;
}
input[type=file] { display: none; }
.preview { 
    width: 100%; aspect-ratio: 1/1; background: #fff; border-radius: 12px; 
    border: 3px solid var(--main-pink); position: relative; overflow: hidden; touch-action: none;
}
canvas { width: 100%; height: 100%; display: block; }
.remove-btn { 
    position: absolute; background: white; color: var(--main-pink); width: 28px; height: 28px; 
    border-radius: 50%; text-align: center; line-height: 28px; font-weight: bold; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: translate(-50%, -50%); z-index: 10;
}
.thumbs { 
    display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding-top: 15px; 
    overflow-y: auto; flex-grow: 1;
}
.thumb { background: white; border: 1px solid #ffccd5; border-radius: 10px; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; }
.thumb img { max-width: 80%; max-height: 80%; }
</style>
</head>
<body>
<div class="wrap">
    <div class="topblock">
        <h1>üíñ Syd√§nStudio</h1>
        <div class="toolbar">
            <label for="file" class="button">Avaa kuva</label>
            <input id="file" type="file" accept="image/*"/>
            <button id="save">Tallenna</button>
            <button id="clear">Tyhjenn√§</button>
        </div>
        <div class="preview" id="preview">
            <canvas id="c" width="1200" height="1200"></canvas>
        </div>
    </div>
    <div id="thumbs" class="thumbs">
        <div class="thumb"><img src="koristeet/sydan1.png" alt="Syd√§n"></div>
    </div>
</div>

<script>
(function(){
    const canvas = document.getElementById('c'), ctx = canvas.getContext('2d', {alpha:false});
    const delBtn = document.createElement('div');
    delBtn.className = 'remove-btn'; delBtn.textContent = '√ó'; delBtn.style.display = 'none';
    document.getElementById('preview').appendChild(delBtn);

    let bgBitmap = null, bg = {x:0, y:0, scale:1}, stickers = [], activeIndex = -1;
    let pointers = new Map(), lastDist = 0, lastScale = 1, dragging = false;

    function getDist(pts) {
        const [p1, p2] = Array.from(pts.values());
        return Math.hypot(p1.x - p2.x, p1.y - p2.y);
    }

    function draw() {
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,1200,1200);
        if(bgBitmap) {
            ctx.save(); ctx.translate(bg.x, bg.y); ctx.scale(bg.scale, bg.scale);
            ctx.drawImage(bgBitmap, 0, 0); ctx.restore();
        }
        stickers.forEach((s, i) => {
            ctx.save(); ctx.translate(s.x, s.y); ctx.scale(s.scale, s.scale);
            const r = Math.min(300/s.img.width, 300/s.img.height);
            ctx.scale(r, r); ctx.drawImage(s.img, -s.img.width/2, -s.img.height/2);
            if(i === activeIndex) {
                ctx.strokeStyle = '#ff4d6d'; ctx.lineWidth = 5;
                ctx.strokeRect(-s.img.width/2, -s.img.height/2, s.img.width, s.img.height);
            }
            ctx.restore();
        });
        updateDelBtn();
    }

    function updateDelBtn() {
        if(activeIndex >= 0) {
            const s = stickers[activeIndex], r = canvas.getBoundingClientRect();
            delBtn.style.display = 'block';
            delBtn.style.left = (s.x * (r.width/1200)) + 'px';
            delBtn.style.top = (s.y * (r.height/1200)) + 'px';
        } else { delBtn.style.display = 'none'; }
    }

    canvas.addEventListener('pointerdown', e => {
        canvas.setPointerCapture(e.pointerId);
        pointers.set(e.pointerId, {x: e.clientX, y: e.clientY});
        if(pointers.size === 1) {
            const r = canvas.getBoundingClientRect(), px = (e.clientX - r.left)*(1200/r.width), py = (e.clientY - r.top)*(1200/r.height);
            activeIndex = stickers.findIndex(s => Math.abs(s.x - px) < 150*s.scale && Math.abs(s.y - py) < 150*s.scale);
            dragging = true;
        } else if(pointers.size === 2) {
            lastDist = getDist(pointers);
            lastScale = activeIndex >= 0 ? stickers[activeIndex].scale : bg.scale;
        }
        draw();
    });

    canvas.addEventListener('pointermove', e => {
        if(!pointers.has(e.pointerId)) return;
        const p = pointers.get(e.pointerId);
        const dx = (e.clientX - p.x) * (1200/canvas.getBoundingClientRect().width);
        const dy = (e.clientY - p.y) * (1200/canvas.getBoundingClientRect().height);
        p.x = e.clientX; p.y = e.clientY;

        if(pointers.size === 1 && dragging) {
            if(activeIndex >= 0) { stickers[activeIndex].x += dx; stickers[activeIndex].y += dy; }
            else { bg.x += dx; bg.y += dy; }
        } else if(pointers.size === 2) {
            const newDist = getDist(pointers);
            const factor = newDist / lastDist;
            if(activeIndex >= 0) stickers[activeIndex].scale = lastScale * factor;
            else bg.scale = lastScale * factor;
        }
        draw();
    });

    const end = e => { pointers.delete(e.pointerId); if(pointers.size < 2) lastDist = 0; dragging = false; };
    canvas.addEventListener('pointerup', end); canvas.addEventListener('pointercancel', end);

    document.getElementById('file').onchange = async e => {
        const f = e.target.files[0]; if(!f) return;
        bgBitmap = await createImageBitmap(f);
        bg.scale = Math.min(1200/bgBitmap.width, 1200/bgBitmap.height);
        bg.x = (1200 - bgBitmap.width*bg.scale)/2; bg.y = (1200 - bgBitmap.height*bg.scale)/2;
        draw();
    };

    document.getElementById('thumbs').onclick = e => {
        if(e.target.tagName === 'IMG') {
            const img = new Image(); img.onload = () => {
                stickers.push({img, x: 600, y: 600, scale: 1});
                activeIndex = stickers.length - 1; draw();
            }; img.src = e.target.src;
        }
    };

    delBtn.onclick = () => { if(activeIndex >= 0) { stickers.splice(activeIndex, 1); activeIndex = -1; draw(); } };
    document.getElementById('save').onclick = () => { const a = document.createElement('a'); a.download = 'kuva.png'; a.href = canvas.toDataURL(); a.click(); };
    document.getElementById('clear').onclick = () => { location.reload(); };

    draw();
})();
</script>
</body>
</html>
