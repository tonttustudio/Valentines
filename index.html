<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<title>Syd√§nStudio ‚Äì Yst√§v√§np√§iv√§ ‚ú®</title>

<style>
:root {
  --red: #ff4d6d;
  --gold-edge: #c9184a;
  --bg-color: #fff0f3;
  --dark-pink: #590d22;
}

html, body { height: 100%; margin: 0; padding: 0; }
body {
  background: var(--bg-color);
  color: var(--dark-pink);
  font-family: 'Fredoka', sans-serif;
  -webkit-font-smoothing: antialiased;
}

.wrap { max-width: 720px; margin: 0 auto; padding: 16px; position: relative; }
.topblock { position: sticky; top: 0; z-index: 500; background: var(--bg-color); padding-bottom: 4px; }

h1 {
  margin: 0; padding: 6px 0 12px;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  font-size: 42px; color: var(--red);
  font-family: 'Dancing Script', cursive;
  text-shadow: 0 2px 0 rgba(255,255,255,.8);
}

.toolbar { display: flex; gap: 10px; justify-content: center; margin-bottom: 12px; }
button, label.button {
  background: linear-gradient(#ff758f, var(--red));
  color: #fff; border: 2px solid var(--gold-edge);
  padding: 10px 18px; border-radius: 24px; font-weight: 500;
  box-shadow: 0 4px 0 #c9184a, 0 8px 18px rgba(0,0,0,.1);
  cursor: pointer; font-family: 'Fredoka', sans-serif;
  white-space: nowrap;
}

input[type=file] { display: none; }

.preview {
  width: calc(100% + 32px); margin: 0 -16px 18px;
  aspect-ratio: 1/1; background: #fff; border-radius: 16px;
  border: 3px solid var(--red); overflow: hidden; touch-action: none;
  position: relative; transform: scale(0.95);
  box-shadow: 0 18px 40px rgba(0,0,0,0.1);
}

canvas { width: 100%; height: 100%; display: block; }

.thumbs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 4px 2px 2px; }
.thumb { 
  border-radius: 14px; padding: 6px; background: #fff; 
  border: 1px solid #ffccd5; aspect-ratio: 1/1; 
  display: flex; align-items: center; justify-content: center; overflow: hidden; 
}
.thumb img { max-width: 100%; max-height: 100%; cursor: pointer; }

.thumb-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 17px; font-weight: 500; color: var(--dark-pink);
  text-align: left; padding-left: 4px; margin: 18px 0 6px;
  grid-column: 1 / -1;
}

.remove-btn {
  position: absolute; color: #fff; background: var(--red);
  width: 28px; height: 28px; border-radius: 50%;
  text-align: center; line-height: 26px; font-weight: 900;
  z-index: 5; transform: translate(-50%, -50%); box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  cursor: pointer;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="topblock">
    <h1>üíñ Syd√§nStudio</h1>
    <div class="toolbar">
      <label for="file" class="button">Avaa kuva</label>
      <input id="file" type="file" accept="image/*,image/heic,image/heif,image/webp"/>
      <button id="save">Tallenna</button>
      <button id="clear">Tyhjenn√§</button>
    </div>
    <div class="preview" id="preview">
      <canvas id="c" width="1200" height="1200"></canvas>
    </div>
  </div>

  <div id="thumbs" class="thumbs">
    <div class="thumb-title">Syd√§met</div>
    <div class="thumb"><img src="koristeet/sydan1.png" alt="Syd√§n" /></div>
    <div class="thumb-title">Tekstit</div>
    <div class="thumb"><img src="koristeet/love1.png" alt="Love" /></div>
    <div class="thumb-title">Kukat ja muut</div>
    <div class="thumb"><img src="koristeet/kukka1.png" alt="Kukka" /></div>
  </div>
</div>

<script>
let bgBitmap = null;
(function(){
    'use strict';
    const canvas = document.getElementById('c'), ctx = canvas.getContext('2d', { alpha:false });
    const fileInput = document.getElementById('file');
    const preview = document.getElementById('preview');

    let bg = { x:0, y:0, scale:1 }, stickers = [], activeIndex = -1;
    let pointers = new Map(), lastPinchDist = 0, initialScale = 1;

    const delBtn = document.createElement('div');
    delBtn.className = 'remove-btn'; delBtn.textContent = '√ó'; delBtn.style.display = 'none';
    preview.appendChild(delBtn);

    function getDistance(p1, p2) { return Math.hypot(p1.clientX - p2.clientX, p1.clientY - p2.clientY); }
    function getMidpoint(p1, p2) { return { x: (p1.clientX + p2.clientX) / 2, y: (p1.clientY + p2.clientY) / 2 }; }

    canvas.addEventListener('pointerdown', e => {
        canvas.setPointerCapture(e.pointerId);
        pointers.set(e.pointerId, e);
        const r = canvas.getBoundingClientRect();
        if (pointers.size === 1) {
            const px = (e.clientX - r.left) * (1200 / r.width);
            const py = (e.clientY - r.top) * (1200 / r.height);
            activeIndex = stickers.findIndex(s => Math.abs(s.x - px) < 150*s.scale && Math.abs(s.y - py) < 150*s.scale);
        } else if (pointers.size === 2) {
            const pts = Array.from(pointers.values());
            lastPinchDist = getDistance(pts[0], pts[1]);
            initialScale = activeIndex >= 0 ? stickers[activeIndex].scale : bg.scale;
        }
        draw();
    });

    canvas.addEventListener('pointermove', e => {
        if (!pointers.has(e.pointerId)) return;
        const r = canvas.getBoundingClientRect();
        const ratio = 1200 / r.width;
        const prevP = pointers.get(e.pointerId);
        const dx = (e.clientX - prevP.clientX) * ratio;
        const dy = (e.clientY - prevP.clientY) * ratio;
        pointers.set(e.pointerId, e);

        if (pointers.size === 1) {
            if (activeIndex >= 0) { stickers[activeIndex].x += dx; stickers[activeIndex].y += dy; }
            else { bg.x += dx; bg.y += dy; }
        } else if (pointers.size === 2) {
            const pts = Array.from(pointers.values());
            const currentDist = getDistance(pts[0], pts[1]);
            const currentMid = getMidpoint(pts[0], pts[1]);
            const factor = currentDist / lastPinchDist;
            const newScale = initialScale * factor;

            if (activeIndex >= 0) {
                stickers[activeIndex].scale = newScale;
            } else {
                const midX = (currentMid.x - r.left) * ratio;
                const midY = (currentMid.y - r.top) * ratio;
                bg.x = midX - (midX - bg.x) * (newScale / bg.scale);
                bg.y = midY - (midY - bg.y) * (newScale / bg.scale);
                bg.scale = newScale;
            }
        }
        draw();
    });

    const end = e => { pointers.delete(e.pointerId); if(pointers.size < 2) lastPinchDist = 0; };
    canvas.addEventListener('pointerup', end); canvas.addEventListener('pointercancel', end);

    function draw() {
        ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,1200,1200);
        if(bgBitmap) {
            ctx.save(); ctx.translate(bg.x, bg.y); ctx.scale(bg.scale, bg.scale);
            ctx.drawImage(bgBitmap, 0, 0); ctx.restore();
        }
        stickers.forEach((s, i) => {
            ctx.save(); ctx.translate(s.x, s.y); ctx.scale(s.scale, s.scale);
            const sc = Math.min(300/s.img.width, 300/s.img.height);
            ctx.scale(sc, sc); ctx.drawImage(s.img, -s.img.width/2, -s.img.height/2);
            if(i === activeIndex) { 
                ctx.strokeStyle = '#ff4d6d'; ctx.lineWidth = 5; 
                ctx.strokeRect(-s.img.width/2, -s.img.height/2, s.img.width, s.img.height); 
            }
            ctx.restore();
        });
        updateDelBtn();
    }

    function updateDelBtn() {
        if(activeIndex >= 0) {
            const s = stickers[activeIndex], r = canvas.getBoundingClientRect();
            delBtn.style.display = 'block';
            delBtn.style.left = (s.x * (r.width/1200)) + 'px';
            delBtn.style.top = (s.y * (r.height/1200)) + 'px';
        } else { delBtn.style.display = 'none'; }
    }

    delBtn.onclick = () => { if(activeIndex >= 0) { stickers.splice(activeIndex, 1); activeIndex = -1; draw(); } };

    // T√ÑSS√Ñ ON P√ÑIVITETTY HEIC-TUKI
    fileInput.onchange = async e => {
        let f = e.target.files[0]; if(!f) return;
        
        // Jos tiedosto on HEIC, muunnetaan se
        if (f.name.toLowerCase().endsWith(".heic") || f.type === "image/heic") {
            try {
                const blob = await heic2any({ blob: f, toType: "image/jpeg", quality: 0.8 });
                f = blob;
            } catch (err) {
                console.error("HEIC muunnos ep√§onnistui", err);
                alert("iPhone-kuvan muunnos ep√§onnistui. Kokeile toista kuvaa.");
                return;
            }
        }

        bgBitmap = await createImageBitmap(f);
        bg.scale = Math.min(1200/bgBitmap.width, 1200/bgBitmap.height);
        bg.x = (1200 - bgBitmap.width*bg.scale)/2; bg.y = (1200 - bgBitmap.height*bg.scale)/2;
        draw();
    };

    document.getElementById('thumbs').onclick = e => {
        if(e.target.tagName === 'IMG') {
            const img = new Image(); img.onload = () => {
                stickers.push({img, x: 600, y: 600, scale: 1});
                activeIndex = stickers.length - 1; draw();
            }; img.src = e.target.src;
        }
    };
    
    document.getElementById('save').onclick = () => { const a = document.createElement('a'); a.download = 'kuva.png'; a.href = canvas.toDataURL(); a.click(); };
    document.getElementById('clear').onclick = () => location.reload();
    draw();
})();
</script>
</body>
</html>
