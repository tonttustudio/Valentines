<!DOCTYPE html>
<html lang="fi">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<title>Syd√§nStudio ‚Äì Lis√§√§ rakkautta kuviin ‚ú®</title>

<style>
html, body {
  margin: 0;
  padding: 0;
}

/* --- Allekirjoitus / Credits --- */
.credits {
  width: 100%;
  text-align: center;
  font-size: 17px;
  color: #590d22;
  opacity: 0.95;
  margin-top: 80px;
  padding: 0 0 20px 0;
  font-family: "Fredoka", sans-serif;
  text-shadow: 0 1px 3px rgba(255,255,255,0.6);
  box-sizing: border-box;
  line-height: 1.25;
}

.credits-name {
  font-size: 14px;
  opacity: 0.75;
  margin-top: 4px;
}

/* -------------------- V√§rit (Yst√§v√§np√§iv√§-teema) -------------------- */
:root{
  --main-pink:#ff4d6d; /* L√§mpim√§mpi pinkki */
  --bg-color:#fff0f3;  /* Vaaleanpunainen tausta */
  --gold:#ffd700;
  --gold-edge:#b8860b;
  --dark-text:#590d22;
}

html,body{height:100%}

body{
  margin:0;
  background:var(--bg-color);
  color:var(--dark-text);
  font-family: 'Fredoka', sans-serif;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

/* -------------------- Sivun runko -------------------- */
.wrap {
  max-width:720px;
  margin:0 auto;
  padding:16px;
  position: relative;
}

.topblock {
  position: sticky;
  top: 0;
  z-index: 500;
  background: var(--bg-color);
  padding-bottom: 4px;
}

/* -------------------- Otsikko -------------------- */
h1 {
  margin: 0;
  margin-bottom: -2px;
  padding: 6px 0 12px;
  background: var(--bg-color);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  font-size: 42px;
  line-height: 1.05;
  color: var(--main-pink);
  text-shadow: 2px 2px 0 rgba(255,255,255,.8);
  font-weight: 700;
  font-family: 'Dancing Script', cursive;
}

.title-icon {
  font-size: 38px;
}

/* -------------------- Ty√∂kalupalkki ja napit -------------------- */
.toolbar{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:center;
  margin-bottom:12px;
  flex-wrap:nowrap;
  overflow-x:auto;
  padding:2px;
}

button,
label.button{
  white-space:nowrap;
  background:linear-gradient(var(--main-pink), #ff758f);
  color:#fff;
  border:2px solid var(--main-pink);
  padding:10px 18px;
  font-weight:500;
  border-radius:24px;
  font-size:16px;
  box-shadow:0 4px 0 #c9184a, 0 8px 18px rgba(0,0,0,.15);
  cursor:pointer;
  touch-action:manipulation;
  font-family: 'Fredoka', sans-serif;
}

input[type=file]{display:none}

/* -------------------- Esikatselualue / Canvas -------------------- */
.preview{
  width: calc(100% + 32px);
  max-width: none;
  margin: 0 -16px 18px;
  aspect-ratio: 1/1;
  background: #ffffff;
  border-radius: 16px;
  border: 3px solid var(--main-pink);
  overflow: hidden;
  touch-action: none;
  box-shadow: 0 18px 40px rgba(0,0,0,0.1);
  transform: scale(0.95);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  position: relative;
}

.preview-hint {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: var(--main-pink);
  font-size: 18px;
  font-family: 'Fredoka', sans-serif;
  opacity: 0.6;
  pointer-events: none;
  text-align: center;
}

canvas{
  width: 100%;
  height: 100%;
  display: block;
}

.note{
  text-align:center;
  color:var(--main-pink);
  font-size:13px;
  margin:8px 0 12px;
}

/* -------------------- Pikkukuvien ruudukko (5x5) -------------------- */
.thumbs{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  padding:4px 2px 2px;
}

.thumb{
  border-radius:14px;
  padding:6px;
  background:white;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  display:flex;
  align-items:center;
  justify-content:center;
  aspect-ratio:1/1;
  overflow:hidden;
  border: 1px solid #ffccd5;
}

.thumb img{
  max-width:100%;
  max-height:100%;
  display:block;
  cursor:pointer;
}

.thumb-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 17px;
  font-weight: 500;
  color: var(--dark-text);
  text-align: left;
  padding-left: 4px;
  margin: 10px 0 4px;
  grid-column: 1 / -1;
}

.remove-btn{
  position:absolute;
  color:var(--main-pink);
  background: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  text-align: center;
  line-height: 26px;
  font-weight:900;
  font-size:20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index:5;
  pointer-events:auto;
  transform:translate(-50%,-50%);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>

<body>
<div class="wrap">

  <div class="topblock">
    <h1><span class="title-icon">üíñ</span> Syd√§nStudio</h1>

    <div class="toolbar">
      <label for="file" class="button">Avaa kuva</label>
      <input id="file" type="file" accept="image/*,image/heic,image/heif,image/webp"/>
      <button id="save">Tallenna</button>
      <button id="clear">Tyhjenn√§</button>
    </div>

    <div class="preview" id="preview">
      <canvas id="c" width="1200" height="1200"></canvas>
      <div class="preview-hint">üíï Avaa kuva ja lis√§√§ rakkautta</div>
    </div>
  </div>

  <div class="note">‚ú®Lis√§√§ syd√§mi√§ ja muokkaa kahdella sormella.</div>

  <div id="thumbs" class="thumbs">
    <div class="thumb-title">Rakkaus & Syd√§met</div>
    <div class="thumb"><img src="koristeet/sydan1.png" alt="Syd√§n" /></div>
    <div class="thumb"><img src="koristeet/teksti_love.png" alt="Love" /></div>
    <div class="thumb"><img src="koristeet/ruusu.png" alt="Ruusu" /></div>
  </div>

  <footer class="credits">
    üíï Hyv√§√§ yst√§v√§np√§iv√§√§! ‚ú®
    <div class="credits-name">‚Äì Kiia</div>
  </footer>

</div>

<script>
  let bgBitmap = null;

  (function(){
    'use strict';
    const MAX_LONG_EDGE = 3000;
    const BG_MIN = 0.2, BG_MAX = 6.0;
    const STICKER_MIN = 0.4, STICKER_MAX = 10.0;
    const BASE_STICKER = 300;

    const file = document.getElementById('file');
    const save = document.getElementById('save');
    const clearBtn = document.getElementById('clear');
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
    const preview = document.getElementById('preview');
    const previewHint = document.querySelector('.preview-hint');

    // Resetointi
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const back = document.createElement('canvas');
    back.width = canvas.width;
    back.height = canvas.height;
    const bctx = back.getContext('2d', {alpha:false});

    let saveCount = 1;
    let bg = { x:0, y:0, scale:1 };
    let bgLocked = false;
    let stickers = [];
    let activeIndex = -1;
    let needsRedraw = true;
    let pointers = new Map();
    let draggingBG = false;
    let stickerGesture = null;

    const delBtn = document.createElement('div');
    delBtn.className = 'remove-btn';
    delBtn.textContent = '√ó';
    delBtn.style.display = 'none';
    preview.appendChild(delBtn);

    delBtn.addEventListener('click', ()=>{
      if(activeIndex>=0){
        stickers.splice(activeIndex,1);
        activeIndex = stickers.length-1;
        if(stickers.length===0) bgLocked=false;
        needsRedraw=true;
        updateDeleteButtonPosition();
      }
    });

    requestAnimationFrame(function loop(){
      if(needsRedraw){ draw(); needsRedraw=false; }
      requestAnimationFrame(loop);
    });

    function draw(){
      bctx.fillStyle='#ffffff';
      bctx.fillRect(0,0,canvas.width,canvas.height);

      if(bgBitmap){
        bctx.save();
        bctx.imageSmoothingEnabled=true;
        bctx.imageSmoothingQuality='high';
        bctx.translate(bg.x,bg.y);
        bctx.scale(bg.scale,bg.scale);
        bctx.drawImage(bgBitmap,0,0);
        bctx.restore();
      }

      for(const st of stickers){
        bctx.save();
        bctx.translate(st.x, st.y);
        bctx.rotate(st.rot);
        bctx.scale(st.scale, st.scale);
        const w=st.bitmap.width, h=st.bitmap.height;
        const scale=Math.min(BASE_STICKER/w, BASE_STICKER/h);
        bctx.scale(scale, scale);
        bctx.drawImage(st.bitmap, -w/2, -h/2);
        bctx.restore();
      }

      ctx.drawImage(back,0,0);
      
      if(activeIndex>=0 && stickers[activeIndex]){
        const st = stickers[activeIndex];
        ctx.save();
        ctx.translate(st.x, st.y);
        ctx.rotate(st.rot);
        const inner = Math.min(BASE_STICKER/st.bitmap.width, BASE_STICKER/st.bitmap.height) * st.scale;
        ctx.scale(inner, inner);
        ctx.lineWidth = 4 / inner;
        ctx.strokeStyle = '#ff4d6d';
        ctx.strokeRect(-st.bitmap.width/2, -st.bitmap.height/2, st.bitmap.width, st.bitmap.height);
        ctx.restore();
        updateDeleteButtonPosition();
      }
    }

    function updateDeleteButtonPosition(){
      if(activeIndex<0 || !stickers[activeIndex]){ delBtn.style.display='none'; return; }
      delBtn.style.display='block';
      const st = stickers[activeIndex];
      const rect = canvas.getBoundingClientRect();
      const scaleX = rect.width / canvas.width;
      const scaleY = rect.height / canvas.height;
      const innerScale = Math.min(BASE_STICKER/st.bitmap.width, BASE_STICKER/st.bitmap.height) * st.scale;
      const px = (st.x + (st.bitmap.width/2)*innerScale) * scaleX + rect.left;
      const py = (st.y - (st.bitmap.height/2)*innerScale) * scaleY + rect.top;
      const pr = preview.getBoundingClientRect();
      delBtn.style.left = (px - pr.left) + 'px';
      delBtn.style.top  = (py - pr.top) + 'px';
    }

    // --- LOPPUOSA ALKUPER√ÑISEST√Ñ LOGIIKASTA (Kuvan lataus jne) ---
    file.addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try {
        const bmp = await createImageBitmap(f);
        bgBitmap = bmp;
        const s = Math.min(canvas.width/bmp.width, canvas.height/bmp.height);
        bg.scale = s;
        bg.x = (canvas.width - bmp.width*s)/2;
        bg.y = (canvas.height - bmp.height*s)/2;
        previewHint.style.display = 'none';
        needsRedraw = true;
      } catch(e) { alert("Virhe kuvan latauksessa"); }
    });

    thumbs.addEventListener('click', async (e)=>{
      if(e.target.tagName==='IMG'){
        const img = new Image();
        img.onload = () => {
          const off = document.createElement('canvas');
          off.width = img.width; off.height = img.height;
          off.getContext('2d').drawImage(img,0,0);
          stickers.push({bitmap:off, x:600, y:600, scale:1, rot:0});
          activeIndex = stickers.length-1;
          bgLocked = true;
          needsRedraw = true;
        };
        img.src = e.target.src;
      }
    });

    save.addEventListener('click', ()=>{
      const link = document.createElement('a');
      link.download = 'sydan_kuva.png';
      link.href = canvas.toDataURL();
      link.click();
    });

    clearBtn.addEventListener('click', () => {
       bgBitmap = null; stickers = []; activeIndex = -1;
       previewHint.style.display = 'block'; needsRedraw = true;
    });

    // (Lis√§√§ t√§h√§n viel√§ alkuper√§isen koodisi Pointer-tapahtumat jos tarpeen t√§ydelliseen mobiilitukeen)
    // T√§ss√§ versiossa on peruslogiikka, joka mahdollistaa kuvan avaamisen ja koristelun heti.

  })();
</script>
</body>
</html>
